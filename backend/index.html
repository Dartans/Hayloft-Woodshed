<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hayloft Woodshed Product Management</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }

        h1, h2, h3 {
            color: #4a6741; /* Green color for headings */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        input[type="checkbox"] {
            margin-right: 5px;
        }

        button {
            background-color: #4a6741;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;
        }

        button:hover {
            background-color: #3a5233;
        }

        button.delete {
            background-color: #ca3c3c;
        }

        button.delete:hover {
            background-color: #a72e2e;
        }
        
        #pre-populate-form {
            background-color: #4a7baf;
            margin-left: 10px;
        }
        
        #pre-populate-form:hover {
            background-color: #3a6290;
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 5px;
            padding: 25px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            background-color: #f9f9f9;
        }

        .upload-area:hover {
            border-color: #4a6741;
            background-color: #f0f5f0;
        }

        .upload-hint {
            color: #777;
            margin: 10px 0 0;
        }

        #product-images-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .image-preview {
            position: relative;
            width: 150px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        .image-preview img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .image-preview .image-actions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: space-between;
            padding: 5px;
        }

        .image-preview .image-actions button {
            padding: 3px 8px;
            font-size: 12px;
            border-radius: 3px;
        }

        .set-hero {
            background-color: #e6a23c;
        }

        .set-hero:hover {
            background-color: #d49331;
        }

        .hero-image {
            border: 3px solid #e6a23c;
        }

        .hero-image::before {
            content: "Hero";
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e6a23c;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
        }

        .attribute-row {
            display: flex;
            margin-bottom: 10px;
            gap: 10px;
        }

        .attribute-row input {
            flex: 1;
        }

        .attribute-row button {
            flex: 0 0 40px;
        }

        #response-display {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            white-space: pre-wrap;
        }
        
        #edit-mode-indicator {
            margin-left: 15px;
            padding: 5px 10px;
            display: inline-block;
            font-size: 14px;
            border-radius: 3px;
            background-color: #f5f5f5;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            cursor: pointer;
        }

        .product-card:hover {
            background-color: #f0f0f0;
        }

        .product-card h3 {
            margin-top: 0;
            font-size: 16px;
        }

        .product-card img {
            max-width: 100%;
            height: auto;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f0f0f0;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }

        .tab.active {
            background-color: #4a6741;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
        
        /* Product search dialog styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 5px;
            width: 70%;
            max-width: 700px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .modal-close:hover {
            color: black;
        }
        
        .product-search-list {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .product-search-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        
        .product-search-item:hover {
            background-color: #f5f5f5;
        }
        
        .product-search-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            margin-right: 15px;
        }
        
        .search-button {
            background-color: #4a7baf;
            margin-left: 10px;
        }
        
        .search-button:hover {
            background-color: #3a6290;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Hayloft Woodshed Product Management</h1>
        
        <div class="tabs">
            <div class="tab active" data-tab="manage">Manage Products</div>
            <div class="tab" data-tab="browse">Browse Products</div>
        </div>
        
        <!-- Product Search Modal -->
        <div id="product-search-modal" class="modal">
            <div class="modal-content">
                <span class="modal-close">&times;</span>
                <h2>Search Products</h2>
                <div>
                    <input type="text" id="product-search-input" placeholder="Search by name or ID...">
                    <button id="product-search-button">Search</button>
                </div>
                <div class="product-search-list" id="product-search-results">
                    <!-- Search results will be added here -->
                </div>
            </div>
        </div>

        <div id="tab-manage" class="tab-content active">
            <div class="form-section">
                <h2>Add or Update Product</h2>
                
                <form id="product-form">
                    <div class="form-group">
                        <label for="product-id">Product ID (auto-generated for new products)</label>
                        <input type="text" id="product-id" placeholder="Enter product ID to load">
                        <button type="button" id="load-product">Load Existing Product</button>
                        <button type="button" id="search-products" class="search-button">Search Products</button>
                    </div>
                    
                    <div class="form-group">
                        <label for="product-name">Product Name *</label>
                        <input type="text" id="product-name" placeholder="Product Name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="product-price">Price *</label>
                        <input type="number" id="product-price" step="0.01" placeholder="999.00" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="product-status">Status *</label>
                        <select id="product-status" required>
                            <option value="available">Available</option>
                            <option value="sold">Sold</option>
                            <option value="bidding">Bidding</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="product-featured">
                            Featured Product
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label for="product-category">Category *</label>
                        <select id="product-category" required>
                            <option value="woodwork">Woodwork</option>
                            <option value="paintings">Paintings</option>
                            <option value="knits">Knits</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="product-description">Description</label>
                        <textarea id="product-description" rows="4" placeholder="Product description..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="product-dimensions">Dimensions</label>
                        <input type="text" id="product-dimensions" placeholder='72" x 36" x 30"'>
                    </div>
                    
                    <div class="form-group">
                        <label for="product-materials">Materials</label>
                        <input type="text" id="product-materials" placeholder="Black Walnut, Danish Oil Finish">
                    </div>
                    
                    <div class="form-group">
                        <label>Product Images</label>
                        <div id="image-upload-container">
                            <div class="image-upload-preview"></div>
                            <div class="upload-area">
                                <input type="file" id="image-upload" multiple accept="image/*" style="display: none;">
                                <button type="button" id="image-upload-btn">Upload Images</button>
                                <p class="upload-hint">Drag and drop images here or click to upload</p>
                            </div>
                        </div>
                        
                        <div id="product-images-list">
                            <!-- Image previews will be added here -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Attributes</label>
                        <div id="attributes-container">
                            <div class="attribute-row">
                                <input type="text" class="attribute-name" placeholder="Attribute Name">
                                <input type="text" class="attribute-value" placeholder="Attribute Value">
                            </div>
                        </div>
                        <button type="button" id="add-attribute">Add Attribute</button>
                    </div>

                    <!-- Hidden fields that will be auto-generated -->
                    <input type="hidden" id="product-path">
                    <input type="hidden" id="product-thumbnail">
                    <input type="hidden" id="product-date">
                    
                    <div class="form-group">
                        <button type="submit" id="save-product">Save Product</button>
                        <button type="button" id="delete-product" class="delete">Delete Product</button>
                        <button type="button" id="reset-form">Reset Form</button>
                        <button type="button" id="pre-populate-form">Pre-populate Form</button>
                        <span id="edit-mode-indicator"></span>
                    </div>
                </form>
            </div>
            
            <div id="response-display">
                API response will appear here...
            </div>
        </div>
        
        <div id="tab-browse" class="tab-content">
            <div class="form-section">
                <h2>Browse Products</h2>
                
                <div class="form-group">
                    <label for="filter-category">Filter by Category</label>
                    <select id="filter-category">
                        <option value="">All Categories</option>
                        <option value="woodwork">Woodwork</option>
                        <option value="paintings">Paintings</option>
                        <option value="knits">Knits</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="filter-status">Filter by Status</label>
                    <select id="filter-status">
                        <option value="">All Statuses</option>
                        <option value="available">Available</option>
                        <option value="sold">Sold</option>
                        <option value="bidding">Bidding</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="filter-featured">
                        Featured Products Only
                    </label>
                </div>
                
                <div class="form-group">
                    <label for="sort-by">Sort By</label>
                    <select id="sort-by">
                        <option value="newest">Newest First</option>
                        <option value="price-high">Price (High to Low)</option>
                        <option value="price-low">Price (Low to High)</option>
                        <option value="name">Name</option>
                    </select>
                </div>
                
                <button id="apply-filters">Apply Filters</button>
            </div>
            
            <div class="products-grid" id="products-grid"></div>
        </div>
    </div>
    
    <script>
        // API Base URL
        const API_BASE_URL = 'http://localhost:3000/api';
        
        // DOM Elements
        const productForm = document.getElementById('product-form');
        const loadProductBtn = document.getElementById('load-product');
        const saveProductBtn = document.getElementById('save-product');
        const deleteProductBtn = document.getElementById('delete-product');
        const resetFormBtn = document.getElementById('reset-form');
        const addAttributeBtn = document.getElementById('add-attribute');
        const responseDisplay = document.getElementById('response-display');
        const applyFiltersBtn = document.getElementById('apply-filters');
        const productsGrid = document.getElementById('products-grid');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Form Elements
        const productIdInput = document.getElementById('product-id');
        const productNameInput = document.getElementById('product-name');
        const productPathInput = document.getElementById('product-path'); // Hidden
        const productThumbnailInput = document.getElementById('product-thumbnail'); // Hidden
        const productPriceInput = document.getElementById('product-price');
        const productStatusSelect = document.getElementById('product-status');
        const productFeaturedCheckbox = document.getElementById('product-featured');
        const productDateInput = document.getElementById('product-date'); // Hidden
        const productCategorySelect = document.getElementById('product-category');
        const productDescriptionTextarea = document.getElementById('product-description');
        const productDimensionsInput = document.getElementById('product-dimensions');
        const productMaterialsInput = document.getElementById('product-materials');
        const attributesContainer = document.getElementById('attributes-container');
        
        // Image upload elements
        const imageUploadBtn = document.getElementById('image-upload-btn');
        const imageUploadInput = document.getElementById('image-upload');
        const uploadArea = document.querySelector('.upload-area');
        const productImagesList = document.getElementById('product-images-list');
        
        // Store uploaded images
        let uploadedImages = [];
        let heroImageIndex = 0; // Index of the hero image
        
        // Utility function to ensure image URLs are properly formatted with API base URL
        function getFullImageUrl(url) {
            if (!url) return '';
            // If URL is already absolute (starts with http or https), return as is
            if (url.startsWith('http://') || url.startsWith('https://')) {
                return url;
            }
            // If URL starts with a slash, append to API base URL
            if (url.startsWith('/')) {
                return API_BASE_URL + url;
            }
            // Otherwise return the URL as is
            return url;
        }
        
        // Filter Elements
        const filterCategorySelect = document.getElementById('filter-category');
        const filterStatusSelect = document.getElementById('filter-status');
        const filterFeaturedCheckbox = document.getElementById('filter-featured');
        const sortBySelect = document.getElementById('sort-by');
        
        // Set default date to today
        const today = new Date();
        const formattedDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        productDateInput.value = formattedDate;
        
        // Initialize form mode
        updateFormMode();
        
        // Add event listener for product ID changes
        productIdInput.addEventListener('input', updateFormMode);
        
        // Tab switching functionality
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                // Update active tab
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Show active content
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `tab-${tabId}`) {
                        content.classList.add('active');
                    }
                });
                
                // If browsing tab, load products
                if (tabId === 'browse') {
                    fetchProducts();
                }
            });
        });
        
        // Image upload functionality
        imageUploadBtn.addEventListener('click', () => {
            imageUploadInput.click();
        });
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        
        imageUploadInput.addEventListener('change', () => {
            handleFiles(imageUploadInput.files);
        });
        
        function handleFiles(files) {
            if (!files || files.length === 0) return;
            
            // Convert FileList to array and add to uploadedImages
            const newImages = Array.from(files).map(file => ({
                file,
                url: URL.createObjectURL(file),
                name: file.name,
                isHero: uploadedImages.length === 0 // First image is hero by default
            }));
            
            // If this is the first batch of images, set the first one as hero
            if (uploadedImages.length === 0 && newImages.length > 0) {
                heroImageIndex = 0;
            }
            
            // Add new images to the array
            uploadedImages = [...uploadedImages, ...newImages];
            
            // Display image previews
            renderImagePreviews();
        }
        
        function renderImagePreviews() {
            // Clear existing previews
            productImagesList.innerHTML = '';
            
            // Create preview for each image
            uploadedImages.forEach((image, index) => {
                const preview = document.createElement('div');
                preview.className = `image-preview ${index === heroImageIndex ? 'hero-image' : ''}`;
                
                // Get proper image URL (handle API server URLs)
                const imageUrl = getFullImageUrl(image.url);
                
                preview.innerHTML = `
                    <img src="${imageUrl}" alt="Product image">
                    <div class="image-actions">
                        <button type="button" class="set-hero" ${index === heroImageIndex ? 'disabled' : ''}>
                            ${index === heroImageIndex ? 'Hero Image' : 'Set as Hero'}
                        </button>
                        <button type="button" class="delete-image">Remove</button>
                    </div>
                `;
                
                // Set hero image event
                preview.querySelector('.set-hero').addEventListener('click', () => {
                    heroImageIndex = index;
                    renderImagePreviews();
                });
                
                // Delete image event
                preview.querySelector('.delete-image').addEventListener('click', () => {
                    URL.revokeObjectURL(image.url); // Free up memory
                    uploadedImages.splice(index, 1);
                    
                    // Adjust hero image index if needed
                    if (index === heroImageIndex) {
                        heroImageIndex = uploadedImages.length > 0 ? 0 : -1;
                    } else if (index < heroImageIndex) {
                        heroImageIndex--;
                    }
                    
                    renderImagePreviews();
                });
                
                productImagesList.appendChild(preview);
            });
        }
        
        // Add Attribute Row
        addAttributeBtn.addEventListener('click', () => {
            const newAttributeRow = document.createElement('div');
            newAttributeRow.className = 'attribute-row';
            newAttributeRow.innerHTML = `
                <input type="text" class="attribute-name" placeholder="Attribute Name">
                <input type="text" class="attribute-value" placeholder="Attribute Value">
                <button type="button" class="delete-row">X</button>
            `;
            
            newAttributeRow.querySelector('.delete-row').addEventListener('click', () => {
                newAttributeRow.remove();
            });
            
            attributesContainer.appendChild(newAttributeRow);
        });
        
        // Load Product
        loadProductBtn.addEventListener('click', async () => {
            const productId = productIdInput.value.trim();
            
            if (!productId) {
                showResponse({ 
                    success: false, 
                    error: { message: 'Please enter a product ID in the Product ID field' } 
                });
                return;
            }
            
            try {
                // Show loading message
                showResponse({ 
                    success: true, 
                    message: `Loading product ${productId}...` 
                });
                
                const response = await fetch(`${API_BASE_URL}/products/${productId}`);
                const data = await response.json();
                
                if (data.success) {
                    populateForm(data.product);
                    showResponse({ 
                        success: true, 
                        message: `Product ${productId} loaded successfully` 
                    });
                } else {
                    showResponse(data);
                }
            } catch (error) {
                showResponse({ 
                    success: false, 
                    error: { 
                        message: `Error loading product: ${error.message}` 
                    } 
                });
            }
        });
        
        // Save Product
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                // Gather form data
                let productData = getProductDataFromForm();
                
                // Process image uploads if needed
                if (productData.processUploadedImages) {
                    showResponse({
                        success: true,
                        message: "Processing images, please wait..."
                    });
                    productData = await productData.processUploadedImages();
                    delete productData.processUploadedImages; // Remove function before sending
                }
                
                // Send data to API
                const response = await fetch(`${API_BASE_URL}/manage/products`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(productData)
                });
                
                const data = await response.json();
                showResponse(data);
                
                if (data.success) {
                    // Maybe refresh the form or keep it as is
                }
            } catch (error) {
                showResponse({ 
                    success: false, 
                    error: { 
                        message: `Error saving product: ${error.message}` 
                    } 
                });
            }
        });
        
        // Delete Product
        deleteProductBtn.addEventListener('click', async () => {
            const productId = productIdInput.value.trim();
            
            if (!productId) {
                showResponse({ success: false, error: { message: 'Please enter a product ID to delete' } });
                return;
            }
            
            if (!confirm(`Are you sure you want to delete product "${productId}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/manage/products/${productId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                showResponse(data);
                
                if (data.success) {
                    resetForm();
                }
            } catch (error) {
                showResponse({ 
                    success: false, 
                    error: { 
                        message: `Error deleting product: ${error.message}` 
                    } 
                });
            }
        });
        
        // Reset Form
        resetFormBtn.addEventListener('click', () => {
            resetForm();
        });
        
        // Pre-populate Form with default values
        document.getElementById('pre-populate-form').addEventListener('click', () => {
            prePopulateForm();
        });
        
        // Apply Filters
        applyFiltersBtn.addEventListener('click', () => {
            fetchProducts();
        });
        
        // Fetch products for browse view
        async function fetchProducts() {
            try {
                // Get filter values
                const category = filterCategorySelect.value;
                const status = filterStatusSelect.value;
                const featured = filterFeaturedCheckbox.checked;
                const sortBy = sortBySelect.value;
                
                // Build query string
                let queryParams = [];
                if (category) queryParams.push(`category=${encodeURIComponent(category)}`);
                if (status) queryParams.push(`status=${encodeURIComponent(status)}`);
                if (featured) queryParams.push('featured=true');
                if (sortBy) queryParams.push(`sort=${encodeURIComponent(sortBy)}`);
                
                const queryString = queryParams.length ? `?${queryParams.join('&')}` : '';
                
                // Fetch products
                const response = await fetch(`${API_BASE_URL}/products${queryString}`);
                const data = await response.json();
                
                if (data.success && data.products) {
                    displayProducts(data.products);
                } else {
                    productsGrid.innerHTML = '<p>No products found</p>';
                }
            } catch (error) {
                productsGrid.innerHTML = `<p>Error fetching products: ${error.message}</p>`;
            }
        }
        
        // Display products in grid
        function displayProducts(products) {
            productsGrid.innerHTML = '';
            
            if (products.length === 0) {
                productsGrid.innerHTML = '<p>No products found with the selected filters</p>';
                return;
            }
            
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                
                // Create thumbnail or placeholder using our utility function
                const thumbnailUrl = getFullImageUrl(product.thumbnail);
                    
                const thumbnail = thumbnailUrl ? 
                    `<img src="${thumbnailUrl}" alt="${product.name}">` : 
                    `<div style="width:100%;height:150px;background:#eee;display:flex;align-items:center;justify-content:center;">No Image</div>`;
                
                card.innerHTML = `
                    ${thumbnail}
                    <h3>${product.name}</h3>
                    <div>Price: $${product.price}</div>
                    <div>Status: ${product.status}</div>
                    ${product.featured ? '<div><strong>Featured</strong></div>' : ''}
                    <div>Category: ${product.category}</div>
                    <div>ID: ${product.id}</div>
                `;
                
                // Add click event to load the product into edit form
                card.addEventListener('click', () => {
                    // Switch to manage tab
                    document.querySelector('.tab[data-tab="manage"]').click();
                    
                    // Load the product
                    productIdInput.value = product.id;
                    loadProduct(product.id);
                });
                
                productsGrid.appendChild(card);
            });
        }
        
        
        // Product Search Modal
        const searchProductsBtn = document.getElementById('search-products');
        const productSearchModal = document.getElementById('product-search-modal');
        const modalClose = document.querySelector('.modal-close');
        const productSearchInput = document.getElementById('product-search-input');
        const productSearchButton = document.getElementById('product-search-button');
        const productSearchResults = document.getElementById('product-search-results');
        
        // Open search modal
        searchProductsBtn.addEventListener('click', () => {
            productSearchModal.style.display = 'block';
            productSearchInput.focus();
            
            // Load all products initially
            searchProducts('');
        });
        
        // Close modal when clicking on X
        modalClose.addEventListener('click', () => {
            productSearchModal.style.display = 'none';
        });
        
        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === productSearchModal) {
                productSearchModal.style.display = 'none';
            }
        });
        
        // Search button click
        productSearchButton.addEventListener('click', () => {
            searchProducts(productSearchInput.value.trim());
        });
        
        // Search on enter key
        productSearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchProducts(productSearchInput.value.trim());
            }
        });
        
        // Search products function
        async function searchProducts(query) {
            try {
                productSearchResults.innerHTML = '<p>Searching...</p>';
                
                // Fetch products from API
                const url = query ? 
                    `${API_BASE_URL}/products?search=${encodeURIComponent(query)}` : 
                    `${API_BASE_URL}/products`;
                    
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success && data.products && data.products.length > 0) {
                    // Clear previous results
                    productSearchResults.innerHTML = '';
                    
                    // Add each product to the results
                    data.products.forEach(product => {
                        const item = document.createElement('div');
                        item.className = 'product-search-item';
                        
                        // Create thumbnail or placeholder
                        // Add API base URL to image path if it's a relative URL
                        const thumbnailUrl = product.thumbnail ? 
                            (product.thumbnail.startsWith('/') ? API_BASE_URL + product.thumbnail : product.thumbnail) : '';
                            
                        const thumbnail = thumbnailUrl ? 
                            `<img src="${thumbnailUrl}" alt="${product.name}">` : 
                            `<div style="width:50px;height:50px;background:#eee;"></div>`;
                        
                        item.innerHTML = `
                            ${thumbnail}
                            <div>
                                <strong>${product.name}</strong>
                                <div>ID: ${product.id}</div>
                                <div>${product.category} - $${product.price}</div>
                            </div>
                        `;
                        
                        // Add click event to select the product
                        item.addEventListener('click', () => {
                            productIdInput.value = product.id;
                            productSearchModal.style.display = 'none';
                            
                            // Load the selected product
                            loadProduct(product.id);
                        });
                        
                        productSearchResults.appendChild(item);
                    });
                } else {
                    productSearchResults.innerHTML = '<p>No products found</p>';
                }
            } catch (error) {
                productSearchResults.innerHTML = `<p>Error searching products: ${error.message}</p>`;
            }
        }
        
        // Extract product loading to a reusable function
        async function loadProduct(productId) {
            if (!productId) {
                showResponse({ 
                    success: false, 
                    error: { message: 'Please enter or select a product ID' } 
                });
                return;
            }
            
            try {
                // Show loading message
                showResponse({ 
                    success: true, 
                    message: `Loading product ${productId}...` 
                });
                
                const response = await fetch(`${API_BASE_URL}/products/${productId}`);
                const data = await response.json();
                
                if (data.success) {
                    populateForm(data.product);
                    showResponse({ 
                        success: true, 
                        message: `Product ${productId} loaded successfully` 
                    });
                } else {
                    showResponse(data);
                }
            } catch (error) {
                showResponse({ 
                    success: false, 
                    error: { 
                        message: `Error loading product: ${error.message}` 
                    } 
                });
            }
        }
        
        // Update the Load Product button to use the new function
        loadProductBtn.addEventListener('click', () => {
            loadProduct(productIdInput.value.trim());
        });
        
        // Helper Functions
        
        function prePopulateForm() {
            // Reset form first
            resetForm();
            
            // Basic product info (no ID - will be generated by backend)
            productNameInput.value = "New Product";
            productPriceInput.value = "99.99";
            productStatusSelect.value = "available";
            productFeaturedCheckbox.checked = false;
            
            // Use the selected category
            const category = productCategorySelect.value;
            
            // Category-specific defaults
            switch(category) {
                case "woodwork":
                    productDescriptionTextarea.value = "Hand-crafted wooden piece made with attention to detail.";
                    productDimensionsInput.value = '24" x 12" x 8"';
                    productMaterialsInput.value = "Walnut, Oil Finish";
                    
                    // Add default attributes for woodwork
                    addDefaultAttributes([
                        { name: "woodType", value: "Walnut" },
                        { name: "finishType", value: "Oil" }
                    ]);
                    
                    // Create dummy images (for demonstration)
                    createDummyImages(category, 2);
                    break;
                    
                case "paintings":
                    productDescriptionTextarea.value = "Original painting with vibrant colors and unique style.";
                    productDimensionsInput.value = '16" x 20"';
                    productMaterialsInput.value = "Acrylic on Canvas";
                    
                    // Add default attributes for paintings
                    addDefaultAttributes([
                        { name: "medium", value: "Acrylic" },
                        { name: "surface", value: "Canvas" }
                    ]);
                    
                    // Create dummy images (for demonstration)
                    createDummyImages(category, 2);
                    break;
                    
                case "knits":
                    productDescriptionTextarea.value = "Hand-knitted item made with premium yarn.";
                    productDimensionsInput.value = 'One Size';
                    productMaterialsInput.value = "Merino Wool";
                    
                    // Add default attributes for knits
                    addDefaultAttributes([
                        { name: "material", value: "Merino Wool" },
                        { name: "care", value: "Hand wash cold" }
                    ]);
                    
                    // Create dummy images (for demonstration)
                    createDummyImages(category, 2);
                    break;
            }
            
            // Show a message to indicate form was pre-populated
            showResponse({ 
                success: true, 
                message: "Form pre-populated with default values. Please update fields as needed." 
            });
        }
        
        // Helper function to add default attributes
        function addDefaultAttributes(attributesList) {
            // Clear existing attributes except the first one
            while (attributesContainer.children.length > 1) {
                attributesContainer.removeChild(attributesContainer.lastChild);
            }
            
            // Get the first attribute row
            const firstAttributeRow = attributesContainer.querySelector('.attribute-row');
            
            if (firstAttributeRow && attributesList.length > 0) {
                // Set first attribute
                const inputs = firstAttributeRow.querySelectorAll('input');
                if (inputs.length >= 2) {
                    inputs[0].value = attributesList[0].name;
                    inputs[1].value = attributesList[0].value;
                }
                
                // Add additional attributes
                for (let i = 1; i < attributesList.length; i++) {
                    const newAttributeRow = document.createElement('div');
                    newAttributeRow.className = 'attribute-row';
                    newAttributeRow.innerHTML = `
                        <input type="text" class="attribute-name" value="${attributesList[i].name}">
                        <input type="text" class="attribute-value" value="${attributesList[i].value}">
                        <button type="button" class="delete-row">X</button>
                    `;
                    
                    newAttributeRow.querySelector('.delete-row').addEventListener('click', () => {
                        newAttributeRow.remove();
                    });
                    
                    attributesContainer.appendChild(newAttributeRow);
                }
            }
        }
        
        // Helper function to create dummy images for demonstration
        function createDummyImages(category, count) {
            // Create placeholder image URLs - in a real app, you would upload images
            const randomNum = Math.floor(Math.random() * 1000);
            const dummyImageUrls = [];
            
            // Create canvas elements to generate dummy color images
            for (let i = 0; i < count; i++) {
                const canvas = document.createElement('canvas');
                canvas.width = 300;
                canvas.height = 300;
                const ctx = canvas.getContext('2d');
                
                // Different colors for different categories
                let color = '#7B3F00'; // Wood brown
                if (category === 'paintings') color = '#4682B4'; // Steel blue
                if (category === 'knits') color = '#9B6A12'; // Yarn color
                
                // Draw a colored rectangle
                ctx.fillStyle = color;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Add some text
                ctx.fillStyle = 'white';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${category} ${i+1}`, canvas.width/2, canvas.height/2);
                
                // Convert to blob URL
                dummyImageUrls.push(canvas.toDataURL());
            }
            
            // Create fake file objects for images
            for (let i = 0; i < dummyImageUrls.length; i++) {
                // Extract base64 data
                const dataUrl = dummyImageUrls[i];
                const arr = dataUrl.split(',');
                const mime = arr[0].match(/:(.*?);/)[1];
                const bstr = atob(arr[1]);
                let n = bstr.length;
                const u8arr = new Uint8Array(n);
                
                while(n--){
                    u8arr[n] = bstr.charCodeAt(n);
                }
                
                // Create a file from the array
                const filename = `dummy-${category}-${i+1}.jpg`;
                const file = new File([u8arr], filename, {type: mime});
                
                // Add to uploadedImages
                uploadedImages.push({
                    file,
                    url: dataUrl,
                    name: filename,
                    isHero: i === 0 // First image is hero
                });
            }
            
            // Set hero index
            heroImageIndex = 0;
            
            // Display the dummy images
            renderImagePreviews();
        }
        
        function resetForm() {
            productForm.reset();
            
            // Clear product ID for new products
            productIdInput.value = '';
            
            // Set today's date in hidden date field
            const today = new Date();
            const formattedDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            productDateInput.value = formattedDate;
            
            // Reset uploaded images
            uploadedImages = [];
            productImagesList.innerHTML = '';
            heroImageIndex = -1;
            
            // Reset attributes
            while (attributesContainer.children.length > 1) {
                attributesContainer.removeChild(attributesContainer.lastChild);
            }
            const firstAttributeRow = attributesContainer.querySelector('.attribute-row');
            if (firstAttributeRow) {
                const inputs = firstAttributeRow.querySelectorAll('input');
                inputs.forEach(input => input.value = '');
            }
            
            // Update UI to show we're in "Create new product" mode
            updateFormMode();
        }
        
        // Function to update form mode based on product ID
        function updateFormMode() {
            const isEditMode = productIdInput.value.trim() !== '';
            const editModeIndicator = document.getElementById('edit-mode-indicator');
            const deleteProductBtn = document.getElementById('delete-product');
            
            // Update mode indicator
            if (isEditMode) {
                editModeIndicator.textContent = `Editing existing product: ${productIdInput.value}`;
                editModeIndicator.style.color = '#4a6741';
                editModeIndicator.style.fontWeight = 'bold';
                deleteProductBtn.style.display = 'inline-block';
            } else {
                editModeIndicator.textContent = 'Creating new product';
                editModeIndicator.style.color = '#666';
                deleteProductBtn.style.display = 'none';
            }
        }
        
        function getProductDataFromForm() {
            // Generate auto fields if this is a new product
            const isNewProduct = !productIdInput.value.trim();
            const productName = productNameInput.value.trim();
            const category = productCategorySelect.value;
            const now = new Date();
            
            // Auto-generate slug from product name
            const productSlug = productName.toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/(^-|-$)/g, '');
                
            // Generate path based on category and slug
            const path = `./${productSlug}.html`;
            
            // Collect attributes
            const attributes = {};
            const attributeRows = document.querySelectorAll('.attribute-row');
            attributeRows.forEach(row => {
                const nameInput = row.querySelector('.attribute-name');
                const valueInput = row.querySelector('.attribute-value');
                
                const name = nameInput.value.trim();
                const value = valueInput.value.trim();
                
                if (name && value) {
                    attributes[name] = value;
                }
            });
            
            // Set hidden fields
            productPathInput.value = path;
            productDateInput.value = now.toISOString().split('T')[0]; // YYYY-MM-DD format
            
            // For new products, we'll let the backend generate an ID
            // For existing products, we keep the ID
            const productData = {
                name: productName,
                price: parseFloat(productPriceInput.value),
                status: productStatusSelect.value,
                featured: productFeaturedCheckbox.checked,
                date: productDateInput.value,
                category: category,
                description: productDescriptionTextarea.value.trim(),
                dimensions: productDimensionsInput.value.trim(),
                materials: productMaterialsInput.value.trim(),
                attributes
            };
            
            // Add id for existing products
            if (!isNewProduct) {
                productData.id = productIdInput.value.trim();
            }
            
            // Add path
            productData.path = path;
            
            // Handle images - include URLs and image data
            if (uploadedImages.length > 0) {
                // Set the hero image as thumbnail
                if (heroImageIndex >= 0 && heroImageIndex < uploadedImages.length) {
                    productThumbnailInput.value = `/uploads/${category}/${productSlug}-thumb.jpg`;
                    productData.thumbnail = productThumbnailInput.value;
                }
                
                // Add all image URLs
                productData.images = uploadedImages.map((image, index) => 
                    `/uploads/${category}/${productSlug}-${index + 1}.jpg`);
                
                // Convert file objects to data URLs for upload
                const imageFilesWithData = [];
                
                // Process each image to include its data URL
                for (const image of uploadedImages) {
                    const reader = new FileReader();
                    imageFilesWithData.push(new Promise((resolve) => {
                        reader.onload = (e) => {
                            resolve({
                                name: image.name,
                                dataUrl: e.target.result
                            });
                        };
                        reader.readAsDataURL(image.file);
                    }));
                }
                
                // This will be resolved when all images are processed
                productData.processUploadedImages = async () => {
                    productData.uploadedImageFiles = await Promise.all(imageFilesWithData);
                    return productData;
                };
            }
            
            return productData;
        }
        
        function populateForm(product) {
            // Reset form first
            resetForm();
            
            // Populate basic fields
            productIdInput.value = product.id || '';
            productNameInput.value = product.name || '';
            productPriceInput.value = product.price || '';
            productStatusSelect.value = product.status || 'available';
            productFeaturedCheckbox.checked = product.featured || false;
            
            // Set hidden fields
            productPathInput.value = product.path || '';
            productThumbnailInput.value = product.thumbnail || '';
            
            // Update UI mode to show we're editing an existing product
            updateFormMode();
            
            if (product.date) {
                // Format date for hidden input
                const date = new Date(product.date);
                const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                productDateInput.value = formattedDate;
            } else {
                const today = new Date();
                productDateInput.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            }
            
            productCategorySelect.value = product.category || 'woodwork';
            productDescriptionTextarea.value = product.description || '';
            productDimensionsInput.value = product.dimensions || '';
            productMaterialsInput.value = product.materials || '';
            
            // Clear existing image previews
            uploadedImages = [];
            productImagesList.innerHTML = '';
            
            // Add product images - simulating uploaded images with remote URLs
            if (product.images && product.images.length > 0) {
                // Find thumbnail index (hero image)
                const thumbUrl = product.thumbnail || '';
                heroImageIndex = product.images.findIndex(img => img === thumbUrl);
                if (heroImageIndex === -1) heroImageIndex = 0;
                
                // Create fake file objects for the existing images
                uploadedImages = product.images.map((imageUrl, index) => {
                    // Extract filename from URL path
                    const filename = imageUrl.split('/').pop();
                    
                    return {
                        url: imageUrl,
                        name: filename,
                        isRemoteUrl: true, // Flag to indicate this is not a File object
                        isHero: index === heroImageIndex
                    };
                });
                
                // Display the images
                renderImagePreviews();
            }
            
            // Populate attributes
            // First clear existing attributes except the first one
            while (attributesContainer.children.length > 1) {
                attributesContainer.removeChild(attributesContainer.lastChild);
            }
            
            // Clear the first attribute inputs
            const firstAttributeRow = attributesContainer.querySelector('.attribute-row');
            if (firstAttributeRow) {
                const inputs = firstAttributeRow.querySelectorAll('input');
                inputs.forEach(input => input.value = '');
            }
            
            // Add product attributes
            if (product.attributes && Object.keys(product.attributes).length > 0) {
                const attributeEntries = Object.entries(product.attributes);
                
                // Fill the first attribute row
                if (firstAttributeRow && attributeEntries.length > 0) {
                    const [name, value] = attributeEntries[0];
                    const inputs = firstAttributeRow.querySelectorAll('input');
                    if (inputs.length >= 2) {
                        inputs[0].value = name;
                        inputs[1].value = value;
                    }
                }
                
                // Add additional attribute rows
                for (let i = 1; i < attributeEntries.length; i++) {
                    const [name, value] = attributeEntries[i];
                    
                    const newAttributeRow = document.createElement('div');
                    newAttributeRow.className = 'attribute-row';
                    newAttributeRow.innerHTML = `
                        <input type="text" class="attribute-name" value="${name}">
                        <input type="text" class="attribute-value" value="${value}">
                        <button type="button" class="delete-row">X</button>
                    `;
                    
                    newAttributeRow.querySelector('.delete-row').addEventListener('click', () => {
                        newAttributeRow.remove();
                    });
                    
                    attributesContainer.appendChild(newAttributeRow);
                }
            }
        }
        
        function showResponse(data) {
            responseDisplay.textContent = JSON.stringify(data, null, 2);
        }
        
        async function fetchProducts() {
            const category = filterCategorySelect.value;
            const status = filterStatusSelect.value;
            const featured = filterFeaturedCheckbox.checked ? 'true' : undefined;
            const sort = sortBySelect.value;
            
            try {
                // Build query parameters
                const queryParams = new URLSearchParams();
                
                if (category) queryParams.append('category', category);
                if (status) queryParams.append('status', status);
                if (featured) queryParams.append('featured', featured);
                queryParams.append('sort', sort);
                
                // Make the request
                const queryString = queryParams.toString() ? `?${queryParams.toString()}` : '';
                const response = await fetch(`${API_BASE_URL}/manage/products${queryString}`);
                
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.products) {
                    renderProducts(data.products);
                } else {
                    productsGrid.innerHTML = '<div>No products found</div>';
                }
            } catch (error) {
                productsGrid.innerHTML = `<div>Error loading products: ${error.message}</div>`;
            }
        }
        
        function renderProducts(products) {
            productsGrid.innerHTML = '';
            
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.dataset.id = product.id;
                
                card.innerHTML = `
                    ${product.thumbnail ? `<img src="${product.thumbnail}" alt="${product.name}">` : ''}
                    <h3>${product.name}</h3>
                    <p>$${product.price.toFixed(2)}</p>
                    <p>${product.category} - ${product.status}</p>
                    ${product.featured ? '<p><strong>Featured</strong></p>' : ''}
                `;
                
                card.addEventListener('click', () => {
                    // Switch to manage tab
                    tabs[0].click();
                    
                    // Load the product data
                    productIdInput.value = product.id;
                    loadProductBtn.click();
                });
                
                productsGrid.appendChild(card);
            });
        }
    </script>
</body>
</html>